# Promto 项目框架文档

## 文档修订记录 (Version History)

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|----------|--------|
| 4.0 | 2025-12-03 | 品牌重塑：项目更名为 Promto，更换 Logo 为 apple-icon.png，全面替换 PromptCraft/Prompt Optimizer 名称 | AI Assistant |
| 3.0 | 2025-12-03 | 多AI Provider支持：添加Gemini/OpenRouter，用户自定义API Key配置界面，实时模型列表获取 | AI Assistant |
| 2.0 | 2025-12-03 | 完整后端架构实现：数据库Schema、API路由、LLM集成、优化服务、评估系统、认证系统 | AI Assistant |
| 1.1 | 2025-12-03 | 完成 Supabase 客户端集成：安装依赖、配置客户端、环境变量、辅助函数 | AI Assistant |
| 1.0 | 2025-12-03 | 初始版本：项目环境搭建和 Cloudflared + Supabase 集成 | AI Assistant |

---

## 一、战略层：背景与目标 (Why)

### 项目背景 (Project Background)

**市场环境分析：**
- AI 应用开发工具需求持续增长
- 开发者需要更高效的 prompt 优化工具
- 云端部署和实时协作成为标准需求

**项目发起原因：**
- 基于 v0.app 快速构建的 AI prompt 优化工具
- 需要建立完整的开发、部署和数据管理体系
- 解决传统 prompt 优化工具的用户体验问题

### 核心价值主张 (Value Proposition)

**要解决的核心问题：**
- 简化 AI prompt 的优化流程
- 提供可视化的数据库管理界面
- 实现公网访问和团队协作

**差异化优势：**
- 基于 Next.js 16 + Turbopack 的高性能前端
- 集成 Supabase 实现实时数据同步
- 使用 Cloudflare Tunnel 实现安全的公网访问，无需暴露服务器端口

### 商业目标 (Business Goals)

**定性目标：**
- 建立稳定的开发和部署流程
- 提供专业的数据库管理能力
- 打造现代化的用户体验

**定量目标 (KPIs)：**
- 页面加载时间 < 2 秒
- 系统可用性 > 99%
- 支持并发用户访问

---

## 二、范围层：用户与场景 (Who & When)

### 用户画像 (User Personas)

**主要用户群体：**
- **角色**：AI 应用开发者、Prompt 工程师
- **技术熟练度**：中高级
- **使用场景**：prompt 优化、测试、管理
- **痛点**：
  - 需要快速迭代和测试 prompt
  - 需要管理和存储历史记录
  - 需要团队协作和分享

### 用户场景 (Use Cases)

**场景 1：Prompt 优化**
- 用户输入原始 prompt
- 系统提供优化建议
- 用户查看和比较结果
- 保存优化后的 prompt

**场景 2：数据管理**
- 管理员通过 Supabase Studio 管理数据
- 创建和修改数据库表结构
- 查看用户数据和使用统计
- 执行数据库维护操作

**场景 3：远程访问**
- 用户通过公网域名访问应用
- 无需 VPN 或端口转发
- 安全加密的数据传输

### 用户故事 (User Stories)

- **US-001**：作为开发者，我想要通过域名访问应用，以便于在任何地方使用
- **US-002**：作为管理员，我想要可视化管理数据库，以便于维护数据
- **US-003**：作为用户，我想要快速加载页面，以便于高效工作

---

## 三、结构层：产品架构与功能 (What)

### 产品功能架构图 (Functional Architecture)

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                 │
├─────────────────────┬─────────────────────┬─────────────────┤
│  Web 应用           │  Supabase Studio    │  API 集成        │
│  (Next.js)          │  (数据库管理)        │                  │
└─────────────────────┴─────────────────────┴─────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Cloudflare Tunnel                          │
│  ┌──────────────────────┐  ┌──────────────────────┐         │
│  │ www.promto.org       │  │ supabase.promto.org  │         │
│  │ → localhost:3000     │  │ → localhost:54323    │         │
│  └──────────────────────┘  └──────────────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      应用服务层                               │
├─────────────────────┬─────────────────────────────────────┐  │
│  Next.js Server     │  Supabase Local                      │  │
│  - Port: 3000       │  - Studio: 54323                     │  │
│  - Turbopack        │  - API: 54321                        │  │
│  - React 19         │  - DB: 54322                         │  │
│                     │  - Mailpit: 54324                    │  │
└─────────────────────┴─────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据层                                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  PostgreSQL Database                                 │   │
│  │  - 用户数据                                           │   │
│  │  - Prompt 历史记录                                   │   │
│  │  - 系统配置                                           │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 技术栈架构

**前端层：**
- Next.js 16.0.3 (App Router)
- React 19.2.0
- Turbopack (构建工具)
- Tailwind CSS 4.1.9
- Radix UI (组件库)
- Framer Motion (动画)

**后端服务：**
- Supabase (BaaS)
  - PostgreSQL 数据库
  - 实时订阅
  - 认证服务
  - 存储服务
- Supabase 客户端集成
  - @supabase/supabase-js (客户端库)
  - @supabase/ssr (SSR 支持)
  - 浏览器端客户端
  - 服务器端客户端
  - React Hooks

**基础设施：**
- Node.js 20.19.6
- Docker (Supabase 本地环境)
- Cloudflared (隧道服务)
- Cloudflare DNS

### 信息架构 (Information Architecture - IA)

**导航结构：**
```
首页
├── Prompt 优化器
│   ├── 输入界面
│   ├── 优化结果
│   └── 历史记录
├── 个人中心
│   ├── 我的 Prompts
│   └── 设置
└── 管理后台 (Supabase Studio)
    ├── 数据库管理
    ├── 认证管理
    └── 存储管理
```

**数据流转逻辑：**
1. 用户输入 → Next.js 前端
2. API 请求 → Supabase API
3. 数据持久化 → PostgreSQL
4. 实时更新 → WebSocket 推送
5. 管理操作 → Supabase Studio

### 全局规则 (Global Rules)

**账号体系：**
- Supabase Auth 提供认证服务
- 支持邮箱/密码登录
- JWT Token 认证
- 会话管理

**异常状态处理：**
- 网络断开：显示离线提示
- 加载失败：显示重试按钮
- 空数据：显示空状态引导
- 错误边界：捕获 React 错误

**权限控制：**
- 公开访问：主页和优化功能
- 登录用户：保存历史记录
- 管理员：Supabase Studio 访问

---

## 四、流程层：业务逻辑 (How)

### 核心业务流程图 (Business Flowcharts)

#### 流程 1：应用部署流程

```
开始
  ↓
安装 Node.js 20.19.6 (使用 nvm)
  ↓
安装项目依赖 (npm install)
  ↓
启动 Next.js 开发服务器 (npm run dev)
  ↓
安装 Supabase CLI
  ↓
初始化 Supabase (supabase init)
  ↓
安装 Docker
  ↓
启动 Supabase (supabase start)
  ↓
配置 Cloudflared Tunnel
  ↓
更新 DNS 记录
  ↓
部署完成
```

#### 流程 2：用户访问流程

```
用户访问域名 (www.promto.org)
  ↓
Cloudflare DNS 解析
  ↓
Cloudflare Tunnel 转发
  ↓
本地 Next.js 服务器 (localhost:3000)
  ↓
渲染页面并返回
  ↓
用户交互
  ↓
API 请求 → Supabase
  ↓
数据库操作
  ↓
返回结果
```

#### 流程 3：数据库管理流程

```
管理员访问 supabase.promto.org
  ↓
Cloudflare Tunnel 转发
  ↓
Supabase Studio (localhost:54323)
  ↓
身份验证
  ↓
选择操作
  ├── 表管理 → 创建/修改表结构
  ├── 数据管理 → CRUD 操作
  ├── SQL 编辑器 → 执行自定义 SQL
  └── 日志查看 → 监控系统
  ↓
操作完成
```

### 页面跳转流程 (UI Flow)

```
首页 (/)
  ↓
  ├→ 优化 Prompt (/optimize)
  │   ↓
  │   ├→ 查看结果
  │   └→ 保存到历史
  │
  ├→ 历史记录 (/history)
  │   ↓
  │   └→ 查看详情
  │
  └→ 登录 (/auth/login)
      ↓
      └→ 个人中心 (/profile)
```

---

## 五、执行层：非功能需求与规划 (Constraints & Plan)

### 非功能性需求 (Non-functional Requirements)

**性能要求：**
- 首屏加载时间 < 2 秒
- API 响应时间 < 500ms
- 支持并发用户数 > 100
- 使用 Turbopack 提升构建速度

**数据埋点：**
- 页面访问量 (PV)
- 用户活跃度 (DAU)
- 功能使用频率
- 错误率监控

**安全需求：**
- HTTPS 加密传输 (通过 Cloudflare)
- JWT Token 认证
- SQL 注入防护 (Supabase ORM)
- XSS 防护 (React 自动转义)
- CORS 配置
- 环境变量保护敏感信息

**兼容性：**
- 浏览器：Chrome, Firefox, Safari, Edge (最新版本)
- Node.js: >= 20.9.0
- Docker: 最新稳定版

**可维护性：**
- TypeScript 类型安全
- ESLint 代码规范
- Git 版本控制
- 文档完善

### 版本规划 (Roadmap)

**MVP (当前版本 - v1.0)：**
- ✅ Next.js 应用基础框架
- ✅ Supabase 本地环境搭建
- ✅ Cloudflared 隧道配置
- ✅ 域名访问能力
- ✅ 数据库管理界面

**V1.1 规划（短期）：**
- [ ] 用户认证系统
- [ ] Prompt 优化核心功能
- [ ] 历史记录管理
- [ ] 响应式设计优化

**V1.2 规划（中期）：**
- [ ] AI 模型集成
- [ ] 实时协作功能
- [ ] 数据导出功能
- [ ] 性能监控面板

**V2.0 规划（长期）：**
- [ ] 多租户支持
- [ ] 高级分析功能
- [ ] API 对外开放
- [ ] 移动端应用

### 风险评估 (Risk Assessment)

**技术风险：**
- **风险**：Cloudflare Tunnel 连接不稳定
- **应对**：配置自动重连，监控服务状态

**风险**：Supabase 本地环境依赖 Docker
- **应对**：提供云端 Supabase 替代方案

**运维风险：**
- **风险**：服务器资源不足
- **应对**：监控资源使用，设置告警

**风险**：配置文件错误导致服务中断
- **应对**：配置文件版本管理，自动验证

**安全风险：**
- **风险**：敏感信息泄露
- **应对**：使用环境变量，不提交到 Git

**风险**：DDoS 攻击
- **应对**：使用 Cloudflare 防护层

---

## 六、附录 (Appendix)

### 部署配置

**环境变量：**
```bash
# Supabase 配置
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=sb_publishable_ACJWlzQHlZjBrEguHvfOxg_3BJgxAaH
SUPABASE_SERVICE_ROLE_KEY=sb_secret_N7UND0UgjKTVK-Uodkm0Hg_xSvEMPvz

# 数据库连接
DATABASE_URL=postgresql://postgres:postgres@127.0.0.1:54322/postgres
```

**Cloudflared 配置：**
```yaml
tunnel: 9557c896-c0d5-4b97-b4d2-dc8fd8cd93b0
credentials-file: /etc/cloudflared/9557c896-c0d5-4b97-b4d2-dc8fd8cd93b0.json

ingress:
  - hostname: www.promto.org
    service: http://localhost:3000
  - hostname: supabase.promto.org
    service: http://localhost:54323
  - service: http_status:404
```

**DNS 配置：**
| 记录类型 | 名称 | 目标 |
|----------|------|------|
| CNAME | www | 9557c896-c0d5-4b97-b4d2-dc8fd8cd93b0.cfargotunnel.com |
| CNAME | supabase | 9557c896-c0d5-4b97-b4d2-dc8fd8cd93b0.cfargotunnel.com |

### 服务端口映射

| 服务 | 本地端口 | 公网域名 | 用途 |
|------|----------|----------|------|
| Next.js | 3000 | www.promto.org | 主应用 |
| Supabase API | 54321 | - | REST/GraphQL API |
| Supabase Studio | 54323 | supabase.promto.org | 数据库管理 |
| PostgreSQL | 54322 | - | 数据库 |
| Mailpit | 54324 | - | 邮件测试 |

### 设计规范 (Design System)

**UI 组件库：**
- Radix UI（无样式组件基础）
- Tailwind CSS（样式系统）
- Framer Motion（动画）
- Lucide React（图标）

**颜色规范：**
- 使用 Tailwind CSS 默认调色板
- 支持明暗主题切换（next-themes）

**排版规范：**
- 字体：系统默认字体栈
- 间距：基于 Tailwind spacing scale

### 专有名词解释 (Glossary)

- **Turbopack**：Next.js 16 引入的新一代打包工具，比 Webpack 快 700 倍
- **Supabase**：开源的 Firebase 替代品，基于 PostgreSQL
- **Cloudflared**：Cloudflare Tunnel 客户端，用于安全地暴露本地服务
- **BaaS**：Backend as a Service，后端即服务
- **JWT**：JSON Web Token，用于身份认证的令牌格式
- **ORM**：Object-Relational Mapping，对象关系映射

### 相关文档链接

- 快速启动指南：`/home/maxsong/QUICK-START.md`
- Cloudflared 部署指南：`/home/maxsong/cloudflared-supabase-setup.md`
- Supabase 设置指南：`/home/maxsong/supabase-setup-guide.md`
- 项目 README：`/home/maxsong/prompt-optimizer/README.md`

---

### 2025-12-03 - V4.0 品牌重塑 (Promto)

**完成的工作：**

#### 1. 项目更名
- 项目名称从 "Prompt Optimizer" / "PromptCraft" 统一更名为 **Promto**
- 域名从 promptcraft.io 改为 promto.org

#### 2. Logo 更换
- 使用 `apple-icon.png` 作为新 Logo
- 替换了所有使用 Sparkles 图标的地方

#### 3. 修改的文件清单

**配置文件 (3个)：**
- `package.json` - name: "promto"
- `package-lock.json` - name: "promto"
- `supabase/config.toml` - project_id: "promto"

**布局组件 (3个)：**
- `components/layout/navbar.tsx` - Logo 图片 + 名称
- `components/layout/footer.tsx` - Logo 图片 + 名称
- `components/layout/sidebar.tsx` - Logo 图片 + 名称

**页面文件 (6个)：**
- `app/layout.tsx` - 网站标题
- `app/globals.css` - 注释
- `app/login/page.tsx` - Logo + 名称
- `app/register/page.tsx` - Logo + 名称
- `app/dashboard/team/page.tsx` - 邀请链接域名
- `app/dashboard/favorites/page.tsx` - 创建者名称

**组件文件 (2个)：**
- `components/dashboard/templates-grid.tsx` - 模板作者
- `components/landing/testimonials.tsx` - 用户评价

**国际化文件 (1个)：**
- `lib/i18n/translations.ts` - 英文和中文翻译

**服务和数据库文件 (3个)：**
- `lib/services/api-keys.ts` - 加密 salt 名称
- `supabase/migrations/001_initial_schema.sql` - 注释
- `supabase/seed.sql` - 注释

**文档文件 (2个)：**
- `docs/ENV-SETUP.md` - OAuth 应用名称
- `docs/框架.md` - 项目标题和本次更改记录

#### 4. 品牌标识

| 元素 | 新值 |
|------|------|
| 项目名称 | Promto |
| 网站域名 | promto.org |
| Logo 文件 | /public/apple-icon.png |
| 版权声明 | © 2025 Promto |

### 关键脚本

- 部署脚本：`/home/maxsong/deploy-cloudflared.sh`
- 重启脚本：`/home/maxsong/restart-cloudflared.sh`

---

## 更新日志

### 2025-12-03 - 初始部署

**完成的工作：**

1. **Node.js 环境升级**
   - 安装 nvm (Node Version Manager)
   - 升级 Node.js 从 18.19.1 到 20.19.6
   - 满足 Next.js 16 的运行要求

2. **Next.js 应用启动**
   - 安装项目依赖
   - 启动开发服务器在 http://localhost:3000
   - 验证应用正常运行

3. **Supabase 集成**
   - 安装 Supabase CLI 2.65.2
   - 在项目中初始化 Supabase
   - 安装并配置 Docker
   - 启动本地 Supabase 实例
   - 提取认证密钥和数据库连接信息

4. **Cloudflared 配置**
   - 修复原有配置文件的 YAML 语法错误
   - 添加 Supabase Studio 域名映射
   - 更新配置到系统目录
   - 验证配置文件语法

5. **文档和脚本**
   - 创建自动化部署脚本
   - 创建服务重启脚本
   - 编写完整的部署文档
   - 创建快速启动指南
   - 生成项目框架文档

**配置详情：**

- **域名映射：**
  - www.promto.org → Next.js App (port 3000)
  - supabase.promto.org → Supabase Studio (port 54323)

- **Tunnel ID：** 9557c896-c0d5-4b97-b4d2-dc8fd8cd93b0

- **认证密钥：**
  - Publishable Key: sb_publishable_ACJWlzQHlZjBrEguHvfOxg_3BJgxAaH
  - Secret Key: sb_secret_N7UND0UgjKTVK-Uodkm0Hg_xSvEMPvz

**待完成事项：**

1. 重启 Cloudflared 服务（运行 `./restart-cloudflared.sh`）
2. 在 Cloudflare DNS 中添加 `supabase.promto.org` CNAME 记录
3. 验证公网域名访问
4. ~~配置 Next.js 应用的 Supabase 连接~~ ✅ 已完成
5. 开发 Prompt 优化核心功能

---

### 2025-12-03 - Supabase 客户端集成

**完成的工作：**

1. **安装依赖包**
   - @supabase/supabase-js：Supabase JavaScript 客户端库
   - @supabase/ssr：Next.js SSR 支持

2. **创建客户端配置文件**
   - `lib/supabase/client.ts`：浏览器端客户端（用于客户端组件）
   - `lib/supabase/server.ts`：服务器端客户端（用于服务器组件、Server Actions、Route Handlers）
   - `lib/supabase/middleware.ts`：中间件辅助函数（用于会话刷新）

3. **配置 Next.js 中间件**
   - 创建 `middleware.ts` 文件
   - 集成 Supabase 会话管理
   - 配置路由匹配规则

4. **环境变量配置**
   - 创建 `.env.local` 文件（包含实际凭证）
   - 创建 `.env.example` 文件（示例模板）
   - 配置以下变量：
     - NEXT_PUBLIC_SUPABASE_URL
     - NEXT_PUBLIC_SUPABASE_ANON_KEY
     - SUPABASE_SERVICE_ROLE_KEY
     - DATABASE_URL

5. **创建辅助函数和类型定义**
   - `lib/supabase/types.ts`：TypeScript 类型定义
   - `lib/supabase/hooks.ts`：React Hooks（useUser、useSession）
   - `lib/supabase/index.ts`：统一导出文件
   - `lib/supabase/README.md`：完整使用文档

**文件结构：**

```
lib/supabase/
├── client.ts         # 浏览器端客户端
├── server.ts         # 服务器端客户端
├── middleware.ts     # 中间件辅助函数
├── hooks.ts          # React Hooks (useUser, useSession)
├── types.ts          # TypeScript 类型定义
├── index.ts          # 统一导出
└── README.md         # 使用文档

middleware.ts         # Next.js 中间件（会话管理）
.env.local           # 环境变量（本地开发）
.env.example         # 环境变量示例
```

**使用示例：**

客户端组件：
```typescript
'use client'
import { createClient } from '@/lib/supabase/client'
const supabase = createClient()
```

服务器组件：
```typescript
import { createClient } from '@/lib/supabase/server'
const supabase = await createClient()
```

React Hooks：
```typescript
import { useUser } from '@/lib/supabase/hooks'
const { user, loading } = useUser()
```

**功能特性：**

✅ 完整的 TypeScript 类型支持
✅ 浏览器端和服务器端客户端分离
✅ 自动会话管理和刷新
✅ React Hooks 简化状态管理
✅ 符合 Next.js 15+ App Router 最佳实践
✅ 详细的使用文档和示例代码

**下一步建议：**

1. ~~在 Supabase Studio 中创建数据库表~~ ✅ 已完成
2. 使用 `npx supabase gen types typescript --local` 生成类型定义
3. ~~开始在应用中集成认证和数据库功能~~ ✅ 已完成
4. ~~开发 Prompt 优化核心业务逻辑~~ ✅ 已完成

---

### 2025-12-03 - V2.0 后端架构完整实现

**完成的工作：**

#### 1. 数据库Schema设计与实现

创建了完整的数据库迁移文件 `supabase/migrations/001_initial_schema.sql`：

**核心表结构：**
- `profiles` - 用户扩展信息（角色、订阅等级、积分）
- `prompts` - 提示词存储（原始内容、优化内容、评分）
- `optimization_jobs` - 异步优化任务管理
- `evaluations` - LLM评估记录（COSTAR评分维度）
- `usage_records` - 使用量配额记录

**枚举类型：**
- `user_role`: user, pro, admin
- `subscription_tier`: free, pro, enterprise
- `optimization_mode`: quick, deep
- `job_status`: pending, processing, completed, failed, cancelled
- `ai_provider`: openai, anthropic

**辅助函数：**
- `increment_usage()` - 增加使用量
- `check_user_quota()` - 检查配额
- `get_user_stats()` - 获取统计信息

**RLS策略：** 所有表均启用Row Level Security，确保用户只能访问自己的数据。

#### 2. API路由架构

```
app/api/
├── auth/
│   ├── callback/route.ts     # OAuth回调
│   ├── signin/route.ts       # 邮箱登录
│   ├── signup/route.ts       # 邮箱注册
│   ├── signout/route.ts      # 登出
│   └── oauth/route.ts        # OAuth入口
├── prompts/
│   ├── route.ts              # GET列表, POST创建
│   └── [id]/route.ts         # GET/PUT/DELETE单条
├── optimize/
│   ├── quick/route.ts        # 快速优化（流式）
│   └── deep/route.ts         # 深度优化（异步）
├── jobs/
│   └── [id]/route.ts         # 任务状态查询
├── evaluate/
│   └── route.ts              # LLM评估
└── user/
    ├── profile/route.ts      # 用户信息
    └── usage/route.ts        # 使用量统计
```

#### 3. LLM集成（Vercel AI SDK）

安装依赖：`ai`, `@ai-sdk/openai`, `@ai-sdk/anthropic`

**Provider配置：**
```typescript
// lib/ai/providers.ts
- OpenAI: gpt-4o-mini (快速), gpt-4o (深度/评估)
- Anthropic: claude-3-5-haiku (快速), claude-3-5-sonnet (深度/评估)
```

**元提示词模板：**
- `lib/ai/prompts/quick-optimize.ts` - 快速优化系统提示词
- `lib/ai/prompts/deep-optimize.ts` - 深度优化（Reflexion Loop）
- `lib/ai/prompts/evaluate.ts` - LLM-as-a-Judge评估

#### 4. 服务层设计

```
lib/services/
├── prompt.ts         # PromptService - CRUD操作
├── user.ts           # UserService - 用户管理、配额
├── optimization.ts   # OptimizationService - 优化核心逻辑
├── evaluation.ts     # EvaluationService - LLM评估
└── index.ts          # 统一导出
```

**OptimizationService核心功能：**
- `quickOptimize()` - 单次LLM调用优化
- `quickOptimizeStream()` - 流式响应优化
- `createDeepOptimizeJob()` - 创建异步深度优化任务
- `processDeepOptimizeJob()` - Reflexion Loop迭代处理

**EvaluationService核心功能：**
- `evaluate()` - COSTAR维度评估
- `getHistory()` - 获取评估历史
- `compare()` - 对比两个提示词

#### 5. 认证系统完善

**API路由：**
- POST `/api/auth/signin` - 邮箱密码登录
- POST `/api/auth/signup` - 邮箱注册
- POST `/api/auth/signout` - 登出
- POST `/api/auth/oauth` - OAuth入口（GitHub/Google）
- GET `/api/auth/callback` - OAuth回调处理

**中间件保护：**
- 受保护路由：/dashboard, /api/prompts, /api/optimize/deep, /api/evaluate, /api/user, /api/jobs
- 认证路由：/login, /register（已登录重定向到dashboard）
- 公开API：/api/auth, /api/optimize/quick（允许匿名使用）

#### 6. 数据验证（Zod）

```
lib/validators/
├── prompt.ts         # 所有验证Schema
└── index.ts
```

**验证Schema：**
- CreatePromptSchema, UpdatePromptSchema, ListPromptsSchema
- QuickOptimizeSchema, DeepOptimizeSchema
- EvaluatePromptSchema, UpdateProfileSchema

#### 7. API工具函数

```
lib/api/
├── utils.ts          # 响应、认证、限流等工具函数
└── index.ts
```

**功能：**
- `successResponse()`, `errorResponse()` - 统一响应格式
- `requireAuth()` - 认证检查
- `parseBody()`, `parseQuery()` - 请求解析验证
- `withErrorHandler()` - 统一错误处理
- `withRateLimit()` - 限流中间件

**文件结构总览：**

```
lib/
├── ai/
│   ├── providers.ts              # AI Provider配置
│   ├── prompts/
│   │   ├── quick-optimize.ts     # 快速优化提示词
│   │   ├── deep-optimize.ts      # 深度优化提示词
│   │   └── evaluate.ts           # 评估提示词
│   └── index.ts
├── api/
│   ├── utils.ts                  # API工具函数
│   └── index.ts
├── services/
│   ├── prompt.ts                 # 提示词服务
│   ├── user.ts                   # 用户服务
│   ├── optimization.ts           # 优化服务
│   ├── evaluation.ts             # 评估服务
│   └── index.ts
├── validators/
│   ├── prompt.ts                 # 验证Schema
│   └── index.ts
└── supabase/                     # 已有
    └── ...

supabase/
├── migrations/
│   └── 001_initial_schema.sql    # 数据库迁移
├── seed.sql                      # 种子数据
└── config.toml                   # 已有

docs/
├── 框架.md                        # 本文档
├── ENV-SETUP.md                  # 环境变量配置指南（新增）
└── ...
```

**下一步建议：**

1. 运行数据库迁移：`supabase db reset`
2. 配置环境变量（参考 `docs/ENV-SETUP.md`）
3. ~~开发前端UI界面~~ ✅ 已完成设置页面
4. 测试完整的优化流程

---

### 2025-12-03 - V3.0 多AI Provider支持与用户配置

**完成的工作：**

#### 1. 新增AI Provider支持

- **OpenRouter（默认）** - 聚合平台，一个Key访问所有模型
- **Google Gemini** - 支持 Gemini 2.0/1.5 系列
- **保留 OpenAI 和 Anthropic** - 直连支持

#### 2. 用户自定义API Key配置

**数据库迁移** `supabase/migrations/002_user_api_keys.sql`：
- `user_api_keys` 表 - 加密存储用户的API Key
- RLS策略 - 用户只能访问自己的Key
- 辅助函数 - `get_user_api_keys_info()`, `has_api_key()`

**API Key服务** `lib/services/api-keys.ts`：
- AES-256-GCM加密存储
- 支持验证各Provider的Key有效性
- 脱敏显示（只显示前后4位）

#### 3. 实时模型列表获取

**模型服务** `lib/services/models.ts`：
```typescript
fetchOpenRouterModels()  // GET openrouter.ai/api/v1/models
fetchOpenAIModels()      // GET api.openai.com/v1/models
fetchGeminiModels()      // GET generativelanguage.googleapis.com/v1beta/models
getAnthropicModels()     // 硬编码列表（无公开API）
```

#### 4. 新增API路由

| 路由 | 方法 | 功能 |
|------|------|------|
| `/api/settings/api-keys` | GET | 获取用户配置的API Keys信息 |
| `/api/settings/api-keys` | POST | 保存API Key（自动验证） |
| `/api/settings/api-keys` | PUT | 设置默认Provider |
| `/api/settings/api-keys/[provider]` | DELETE | 删除指定Provider的Key |
| `/api/settings/api-keys/[provider]` | POST | 验证指定Provider的Key |
| `/api/models` | GET | 获取可用模型列表 |
| `/api/models/validate` | POST | 验证API Key有效性 |

#### 5. 设置页面UI

**设置页面** `app/settings/api-keys/page.tsx`：
- 显示所有Provider配置状态
- 支持添加/更换/删除API Key
- 验证Key有效性
- 设置默认Provider
- 获取Key链接跳转

#### 6. 动态模型选择器组件

**组件** `components/ui/dynamic-model-selector.tsx`：
- 实时从API获取模型列表
- 按Provider分组显示
- 显示模型标签（推荐/免费/推理）
- 显示上下文长度信息

#### 7. Provider配置更新

**更新** `lib/ai/providers.ts`：
```typescript
// 支持4个Provider
export type AIProvider = 'openai' | 'anthropic' | 'gemini' | 'openrouter'

// 默认使用OpenRouter
export const DEFAULT_PROVIDER: AIProvider = 'openrouter'

// 支持自定义API Key
export function getModel(provider, modelId, apiKey?)
export function getQuickModel(provider?, apiKey?)
export function getDeepModel(provider?, apiKey?)
```

**文件结构更新：**

```
新增文件：
├── supabase/migrations/
│   └── 002_user_api_keys.sql      # 用户API Key表
├── lib/services/
│   ├── api-keys.ts                # API Key服务（加密/验证）
│   └── models.ts                  # 模型列表服务（实时获取）
├── app/api/
│   ├── settings/api-keys/
│   │   ├── route.ts               # GET/POST/PUT
│   │   └── [provider]/route.ts    # DELETE/POST(验证)
│   └── models/
│       ├── route.ts               # GET 模型列表
│       └── validate/route.ts      # POST 验证Key
├── app/settings/
│   ├── layout.tsx                 # 设置页面布局
│   ├── page.tsx                   # 重定向到api-keys
│   └── api-keys/page.tsx          # API Key配置页面
└── components/ui/
    └── dynamic-model-selector.tsx # 动态模型选择器
```

**下一步建议：**

1. 运行新的数据库迁移：`supabase db reset`
2. 访问 `/settings/api-keys` 配置API Key
3. 在优化页面集成动态模型选择器
4. 测试完整的多Provider优化流程

---

*文档最后更新：2025-12-03*

